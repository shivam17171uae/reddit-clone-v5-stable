import React,{useState,useEffect}from 'react';import {useAuth}from '../context/AuthContext';import MarkdownRenderer from './MarkdownRenderer';
const Comment=({comment,postId,onReply})=>{const[replyVisible,setReplyVisible]=useState(false);return(<div className="ml-4 pl-4 border-l border-gray-700"><div className="text-sm"><MarkdownRenderer content={comment.content}/></div><p className="text-xs text-gray-500 mt-1">by u/{comment.username}</p><button onClick={()=>setReplyVisible(!replyVisible)} className="text-xs text-blue-400 hover:underline">Reply</button>{replyVisible&&<div className="mt-2"><CommentForm postId={postId} parentId={comment.id} onCommentPosted={()=>{setReplyVisible(false);onReply();}}/></div>}{comment.children&&comment.children.map(child=><Comment key={child.id} comment={child} postId={postId} onReply={onReply}/>)}</div>);};
const CommentForm=({postId,parentId=null,onCommentPosted})=>{const[content,setContent]=useState('');const{token}=useAuth();const handleSubmit=async(e)=>{e.preventDefault();await fetch(`/api/posts/${postId}/comments`,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},body:JSON.stringify({content,parentId})});setContent('');if(onCommentPosted)onCommentPosted();};return(<form onSubmit={handleSubmit}><textarea value={content} onChange={e=>setContent(e.target.value)} placeholder="Add a comment..." rows="2" className="w-full bg-gray-700 p-2 rounded"></textarea><button type="submit" className="mt-2 bg-blue-600 text-sm py-1 px-3 rounded">Submit</button></form>);};
function CommentSection({postId}){const[comments,setComments]=useState([]);const{user}=useAuth();const fetchComments=async()=>{const r=await fetch(`/api/posts/${postId}/comments`);setComments(await r.json());};useEffect(()=>{fetchComments();},[postId]);return(<div className="mt-4 border-t border-gray-700 pt-4 bg-gray-800 p-4 rounded-b-lg">{user&&<CommentForm postId={postId} onCommentPosted={fetchComments}/>}<h3 className="text-lg font-semibold mb-2">Comments</h3><div className="space-y-4">{comments.map(c=><Comment key={c.id} comment={c} postId={postId} onReply={fetchComments}/>)}</div></div>);}
export default CommentSection;
